image: mcr.microsoft.com/dotnet/sdk:8.0

stages:
  - build
  - test
  - stylecheck

build:
  stage: build
  script:
    - find . -name '*.csproj' ! -name '*Tests*' -exec dotnet build {} \;

test:
  stage: test
  script:
    - find . -name '*Tests*.csproj' -exec dotnet test {} \;


stylecheck:
  stage: stylecheck
  script:
    - dotnet tool install -g stylecop.analyzers
    - find . -name '*.csproj' ! -name '*Tests*' -exec dotnet stylecop {} \;
  
coverage:
  stage: test
  script:
    - find . -name '*Tests*.csproj' -exec bash -c 'dotnet test "$1" && coverlet "$(dirname "$1")/bin/Debug/netcoreapp3.1/$(basename "$1" .csproj).dll" --target "dotnet" --targetargs "test $1 --no-build" --format opencover' _ {} \;
  artifacts:
    paths:
      - '**/*.coverage'
  dependencies:
    - test



